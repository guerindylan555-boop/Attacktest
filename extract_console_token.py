#!/usr/bin/env python3
import re

# Your console output
console_output = """
[UDP SEND] Socket: 164 Length: 308 bytes

================================================================================================


================================================================================================
[LOCK] B4.P3 - Scooter Lock Request
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjox...
  Pass ID: u.S@43da4dd
================================================================================================


================================================================================================
[UNLOCK] B4.d3 - Scooter Unlock Request
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjox...
  Scooter ID: kh.d@b97df26
================================================================================================


================================================================================================
[UDP SEND] Socket: 164 Length: 284 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 138 Length: 1017 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 141 Length: 1198 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 176 Length: 46 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 176 Length: 39 bytes

================================================================================================


================================================================================================
[LOCK] B4.q2 - Scooter Lock Request
  Pass ID: cad428a3-bc97-4f01-840c-57c99b41c597
================================================================================================


================================================================================================
[UDP SEND] Socket: 112 Length: 248 bytes

================================================================================================


================================================================================================
[LOCK] B4.q2 - Scooter Lock Request
  Pass ID: cad428a3-bc97-4f01-840c-57c99b41c597
================================================================================================


================================================================================================
[UDP SEND] Socket: 109 Length: 16 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 177 Length: 16 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 177 Length: 16 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 177 Length: 16 bytes

================================================================================================


================================================================================================
[UNLOCK] B4.i1 - Scooter Unlock Request
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjox...
  Scooter ID: kh.d@417797c
  Location: KnotMapRegion(centerLatitude=47.39049603096516, centerLongitude=0.6889144890010357, latitudeDegrees=0.4727555197723774, longitudeDegrees=0.494384430348873)
================================================================================================


================================================================================================
[UDP SEND] Socket: 109 Length: 16 bytes

================================================================================================


================================================================================================
[UDP SEND] Socket: 112 Length: 130 bytes

================================================================================================


================================================================================================
[UNLOCK] B4.i1 - Scooter Unlock Request
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjox...
  Scooter ID: kh.d@417797c
  Location: KnotMapRegion(centerLatitude=47.39049603096516, centerLongitude=0.6889144890010357, latitudeDegrees=0.4727555197723774, longitudeDegrees=0.494384430348873)
================================================================================================
"""

def extract_tokens():
    """Extract all Bearer tokens from the console output"""
    print("[EXTRACT] Looking for Bearer tokens in console output...")
    
    # Look for Bearer tokens (even truncated ones)
    bearer_pattern = r'Bearer eyJ[A-Za-z0-9_-]+\.\.\.'
    tokens = re.findall(bearer_pattern, console_output)
    
    if tokens:
        print(f"[FOUND] {len(tokens)} Bearer tokens found:")
        for i, token in enumerate(tokens, 1):
            print(f"   {i}. {token}")
        
        # Use the last (most recent) token
        latest_token = tokens[-1]
        print(f"\n[LATEST] Using most recent token: {latest_token}")
        return latest_token
    else:
        print("[ERROR] No Bearer tokens found in console output")
        return None

def main():
    print("=" * 80)
    print("[EXTRACT] CONSOLE TOKEN EXTRACTION")
    print("=" * 80)
    
    token = extract_tokens()
    
    if token:
        # Save to LATEST_TOKEN.txt
        with open('LATEST_TOKEN.txt', 'w', encoding='utf-8') as f:
            f.write(token)
        print(f"\n[SAVED] Token saved to LATEST_TOKEN.txt")
        print(f"[READY] You can now run: py test_tuf061_unlock.py")
    else:
        print("\n[ERROR] No token found to extract")

if __name__ == "__main__":
    main()
